"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _dayjs = _interopRequireDefault(require("dayjs"));

var _EzCalendar = require("./EzCalendar.styles");

var _en = _interopRequireDefault(require("./en"));

var _hooks = require("../../utils/hooks");

var weekDayCount = 7;
var maxDaysInMonth = 31;

var repeat = function repeat(n) {
  return new Array(n).fill(null);
};

var populateMonth = function populateMonth(date) {
  var daysInMonth = date.endOf('month').date();
  var monthDayStartOffset = date.set('date', 1).day() + 1;
  var weeksInMonth = Math.ceil((monthDayStartOffset + daysInMonth) / weekDayCount);
  var tempMonthDayStartOffset = monthDayStartOffset;
  var daysLeftInMonth = date.endOf('month').date();
  return repeat(weeksInMonth).map(function () {
    return repeat(weekDayCount).map(function () {
      if (--tempMonthDayStartOffset > 0) return null;
      var day = daysInMonth - --daysLeftInMonth;
      if (day <= daysInMonth) return day;
      return null;
    });
  });
};

var EzCalendar = function EzCalendar(_ref) {
  var value = _ref.value,
      onChange = _ref.onChange,
      minDate = _ref.minDate,
      maxDate = _ref.maxDate,
      filterDate = _ref.filterDate;

  var _useTranslation = (0, _hooks.useTranslation)(_en["default"]),
      t = _useTranslation.t;

  var calendarRef = (0, _react.useRef)(null);
  var refs = (0, _react.useRef)(repeat(maxDaysInMonth).map(function () {
    return (0, _react.createRef)();
  })).current;
  var selectedDate = (0, _dayjs["default"])(value).isValid() ? (0, _dayjs["default"])(value) : (0, _dayjs["default"])();

  var _useState = (0, _react.useState)(selectedDate),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      focusedDate = _useState2[0],
      setFocusedDate = _useState2[1];

  (0, _react.useEffect)(function () {
    var _calendarRef$current$ = calendarRef.current.ownerDocument,
        activeElement = _calendarRef$current$.activeElement,
        body = _calendarRef$current$.body;
    var bodyFocused = activeElement && activeElement === body;
    var current = refs[focusedDate.date() - 1].current;
    var dateFocused = refs.some(function (el) {
      return el.current === activeElement;
    });
    var canFocus = current && (bodyFocused || dateFocused);
    if (canFocus) current.focus();
  }, [refs, focusedDate, value]);
  (0, _react.useEffect)(function () {
    if ((0, _dayjs["default"])(value).isValid()) setFocusedDate((0, _dayjs["default"])(value));
  }, [value]);

  var handleKeyInput = function handleKeyInput(selectFocusedDate, disabled) {
    return function (e) {
      switch (e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          setFocusedDate(focusedDate.subtract(1, 'day'));
          break;

        case 'ArrowRight':
          e.preventDefault();
          setFocusedDate(focusedDate.add(1, 'day'));
          break;

        case 'ArrowUp':
          e.preventDefault();
          setFocusedDate(focusedDate.subtract(1, 'week'));
          break;

        case 'ArrowDown':
          e.preventDefault();
          setFocusedDate(focusedDate.add(1, 'week'));
          break;

        case 'Space':
        case 'Enter':
          e.preventDefault();
          if (!disabled) selectFocusedDate();
          break;

        default:
          break;
      }
    };
  };

  var isEnabled = function isEnabled(day) {
    var isSameOrAfterMinDate = minDate !== undefined ? day.isSame(minDate) || day.isAfter(minDate) : true;
    var isSameOrBeforeMaxDate = maxDate !== undefined ? day.isSame(maxDate) || day.isBefore(maxDate) : true;
    var isFilterMatch = filterDate !== undefined ? filterDate(day.format(t('DATE_FORMAT'))) : true;
    return isSameOrAfterMinDate && isSameOrBeforeMaxDate && isFilterMatch;
  };

  return _react["default"].createElement("div", null, _react["default"].createElement(_EzCalendar.CalendarTable, {
    ref: calendarRef
  }, _react["default"].createElement(_EzCalendar.Row, null, _react["default"].createElement(_EzCalendar.MonthNavigation, null, _react["default"].createElement("button", {
    type: "button",
    onClick: function onClick() {
      return setFocusedDate(focusedDate.subtract(1, 'month').set('date', 1));
    }
  }, "\u2190 ", t('Prev'))), _react["default"].createElement(_EzCalendar.MonthName, null, focusedDate.format('MMMM YYYY')), _react["default"].createElement(_EzCalendar.MonthNavigation, null, _react["default"].createElement("button", {
    type: "button",
    onClick: function onClick() {
      return setFocusedDate(focusedDate.add(1, 'month').set('date', 1));
    }
  }, t('Next'), " \u2192"))), _react["default"].createElement(_EzCalendar.Row, null, repeat(weekDayCount).map(function (_, dayIndex) {
    return _react["default"].createElement(_EzCalendar.WeekdayName, {
      key: dayIndex
    }, focusedDate.set('day', dayIndex).format('dd'));
  })), _react["default"].createElement("div", null, populateMonth(focusedDate).map(function (week, weekIndex) {
    return _react["default"].createElement(_EzCalendar.Row, {
      key: weekIndex
    }, week.map(function (day, dayIndex) {
      var currentDay = focusedDate.set('date', day);

      var selectDate = function selectDate() {
        return onChange(currentDay.format(t('DATE_FORMAT')));
      };

      var disabled = !isEnabled(currentDay);

      var ifEnabled = function ifEnabled(fn) {
        return function (e) {
          if (!disabled) fn(e);
        };
      };

      return _react["default"].createElement(_EzCalendar.Day, {
        key: dayIndex,
        isSelected: currentDay.isSame(selectedDate)
      }, day && _react["default"].createElement("button", {
        ref: refs[day - 1],
        type: "button",
        onClick: ifEnabled(selectDate),
        "aria-disabled": disabled,
        onKeyDown: handleKeyInput(selectDate, disabled),
        "aria-label": currentDay.format('dddd, MMMM D, YYYY').toString(),
        tabIndex: day === focusedDate.date() ? 0 : -1
      }, day));
    }));
  }))));
};

var _default = EzCalendar;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL0V6Q2FsZW5kYXIvRXpDYWxlbmRhci50c3giXSwibmFtZXMiOlsid2Vla0RheUNvdW50IiwibWF4RGF5c0luTW9udGgiLCJyZXBlYXQiLCJuIiwiQXJyYXkiLCJmaWxsIiwicG9wdWxhdGVNb250aCIsImRhdGUiLCJkYXlzSW5Nb250aCIsImVuZE9mIiwibW9udGhEYXlTdGFydE9mZnNldCIsInNldCIsImRheSIsIndlZWtzSW5Nb250aCIsIk1hdGgiLCJjZWlsIiwidGVtcE1vbnRoRGF5U3RhcnRPZmZzZXQiLCJkYXlzTGVmdEluTW9udGgiLCJtYXAiLCJFekNhbGVuZGFyIiwidmFsdWUiLCJvbkNoYW5nZSIsIm1pbkRhdGUiLCJtYXhEYXRlIiwiZmlsdGVyRGF0ZSIsImVuIiwidCIsImNhbGVuZGFyUmVmIiwicmVmcyIsImN1cnJlbnQiLCJzZWxlY3RlZERhdGUiLCJpc1ZhbGlkIiwiZm9jdXNlZERhdGUiLCJzZXRGb2N1c2VkRGF0ZSIsIm93bmVyRG9jdW1lbnQiLCJhY3RpdmVFbGVtZW50IiwiYm9keSIsImJvZHlGb2N1c2VkIiwiZGF0ZUZvY3VzZWQiLCJzb21lIiwiZWwiLCJjYW5Gb2N1cyIsImZvY3VzIiwiaGFuZGxlS2V5SW5wdXQiLCJzZWxlY3RGb2N1c2VkRGF0ZSIsImRpc2FibGVkIiwiZSIsImtleSIsInByZXZlbnREZWZhdWx0Iiwic3VidHJhY3QiLCJhZGQiLCJpc0VuYWJsZWQiLCJpc1NhbWVPckFmdGVyTWluRGF0ZSIsInVuZGVmaW5lZCIsImlzU2FtZSIsImlzQWZ0ZXIiLCJpc1NhbWVPckJlZm9yZU1heERhdGUiLCJpc0JlZm9yZSIsImlzRmlsdGVyTWF0Y2giLCJmb3JtYXQiLCJfIiwiZGF5SW5kZXgiLCJ3ZWVrIiwid2Vla0luZGV4IiwiY3VycmVudERheSIsInNlbGVjdERhdGUiLCJpZkVuYWJsZWQiLCJmbiIsInRvU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7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QUNMLE1BQVgsQ0FBa0JqQyxDQUFDLENBQUMsYUFBRCxDQUFuQixDQUFELENBQWQ7QUFBQSxPQUFuQjs7QUFDQSxVQUFNbUIsUUFBUSxHQUFHLENBQUNNLFNBQVMsQ0FBQ2EsVUFBRCxDQUEzQjs7QUFDQSxVQUFNRSxTQUFTLEdBQUcsU0FBWkEsU0FBWSxDQUFBQyxFQUFFO0FBQUEsZUFBSSxVQUFBckIsQ0FBQyxFQUFJO0FBQzNCLGNBQUksQ0FBQ0QsUUFBTCxFQUFlc0IsRUFBRSxDQUFDckIsQ0FBRCxDQUFGO0FBQ2hCLFNBRm1CO0FBQUEsT0FBcEI7O0FBR0EsYUFDRSxnQ0FBQyxlQUFEO0FBQUssUUFBQSxHQUFHLEVBQUVlLFFBQVY7QUFBb0IsUUFBQSxVQUFVLEVBQUVHLFVBQVUsQ0FBQ1YsTUFBWCxDQUFrQnhCLFlBQWxCO0FBQWhDLFNBQ0dsQixHQUFHLElBQ0Y7QUFDRSxRQUFBLEdBQUcsRUFBRWdCLElBQUksQ0FBQ2hCLEdBQUcsR0FBRyxDQUFQLENBRFg7QUFFRSxRQUFBLElBQUksRUFBQyxRQUZQO0FBR0UsUUFBQSxPQUFPLEVBQUVzRCxTQUFTLENBQUNELFVBQUQsQ0FIcEI7QUFJRSx5QkFBZXBCLFFBSmpCO0FBS0UsUUFBQSxTQUFTLEVBQUVGLGNBQWMsQ0FBQ3NCLFVBQUQsRUFBYXBCLFFBQWIsQ0FMM0I7QUFNRSxzQkFBWW1CLFVBQVUsQ0FBQ0wsTUFBWCxDQUFrQixvQkFBbEIsRUFBd0NTLFFBQXhDLEVBTmQ7QUFPRSxRQUFBLFFBQVEsRUFBRXhELEdBQUcsS0FBS29CLFdBQVcsQ0FBQ3pCLElBQVosRUFBUixHQUE2QixDQUE3QixHQUFpQyxDQUFDO0FBUDlDLFNBU0dLLEdBVEgsQ0FGSixDQURGO0FBaUJELEtBeEJBLENBREgsQ0FEOEI7QUFBQSxHQUEvQixDQURILENBM0JGLENBREYsQ0FERjtBQStERCxDQTdIRDs7ZUErSGVPLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHt1c2VFZmZlY3QsIHVzZVJlZiwgY3JlYXRlUmVmLCB1c2VTdGF0ZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IGRheWpzIGZyb20gJ2RheWpzJztcblxuaW1wb3J0IHtcbiAgQ2FsZW5kYXJUYWJsZSxcbiAgUm93LFxuICBNb250aE5hdmlnYXRpb24sXG4gIE1vbnRoTmFtZSxcbiAgV2Vla2RheU5hbWUsXG4gIERheSxcbn0gZnJvbSAnLi9FekNhbGVuZGFyLnN0eWxlcyc7XG5cbmltcG9ydCBlbiBmcm9tICcuL2VuJztcbmltcG9ydCB7dXNlVHJhbnNsYXRpb259IGZyb20gJy4uLy4uL3V0aWxzL2hvb2tzJztcblxuY29uc3Qgd2Vla0RheUNvdW50ID0gNztcbmNvbnN0IG1heERheXNJbk1vbnRoID0gMzE7XG5cbmNvbnN0IHJlcGVhdCA9IChuOiBudW1iZXIpID0+IG5ldyBBcnJheShuKS5maWxsKG51bGwpO1xuXG5jb25zdCBwb3B1bGF0ZU1vbnRoID0gKGRhdGU6IGFueSkgPT4ge1xuICBjb25zdCBkYXlzSW5Nb250aCA9IGRhdGUuZW5kT2YoJ21vbnRoJykuZGF0ZSgpO1xuICBjb25zdCBtb250aERheVN0YXJ0T2Zmc2V0ID0gZGF0ZS5zZXQoJ2RhdGUnLCAxKS5kYXkoKSArIDE7XG4gIGNvbnN0IHdlZWtzSW5Nb250aCA9IE1hdGguY2VpbCgobW9udGhEYXlTdGFydE9mZnNldCArIGRheXNJbk1vbnRoKSAvIHdlZWtEYXlDb3VudCk7XG5cbiAgbGV0IHRlbXBNb250aERheVN0YXJ0T2Zmc2V0ID0gbW9udGhEYXlTdGFydE9mZnNldDtcbiAgbGV0IGRheXNMZWZ0SW5Nb250aCA9IGRhdGUuZW5kT2YoJ21vbnRoJykuZGF0ZSgpO1xuXG4gIHJldHVybiByZXBlYXQod2Vla3NJbk1vbnRoKS5tYXAoKCkgPT5cbiAgICByZXBlYXQod2Vla0RheUNvdW50KS5tYXAoKCkgPT4ge1xuICAgICAgaWYgKC0tdGVtcE1vbnRoRGF5U3RhcnRPZmZzZXQgPiAwKSByZXR1cm4gbnVsbDtcblxuICAgICAgY29uc3QgZGF5ID0gZGF5c0luTW9udGggLSAtLWRheXNMZWZ0SW5Nb250aDtcblxuICAgICAgaWYgKGRheSA8PSBkYXlzSW5Nb250aCkgcmV0dXJuIGRheTtcblxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSlcbiAgKTtcbn07XG5cbmNvbnN0IEV6Q2FsZW5kYXIgPSAoe3ZhbHVlLCBvbkNoYW5nZSwgbWluRGF0ZSwgbWF4RGF0ZSwgZmlsdGVyRGF0ZX0pID0+IHtcbiAgY29uc3Qge3R9ID0gdXNlVHJhbnNsYXRpb24oZW4pO1xuICBjb25zdCBjYWxlbmRhclJlZiA9IHVzZVJlZihudWxsKTtcbiAgY29uc3QgcmVmcyA9IHVzZVJlZihyZXBlYXQobWF4RGF5c0luTW9udGgpLm1hcCgoKSA9PiBjcmVhdGVSZWY8SFRNTEJ1dHRvbkVsZW1lbnQ+KCkpKS5jdXJyZW50O1xuXG4gIGNvbnN0IHNlbGVjdGVkRGF0ZSA9IGRheWpzKHZhbHVlKS5pc1ZhbGlkKCkgPyBkYXlqcyh2YWx1ZSkgOiBkYXlqcygpO1xuXG4gIGNvbnN0IFtmb2N1c2VkRGF0ZSwgc2V0Rm9jdXNlZERhdGVdID0gdXNlU3RhdGUoc2VsZWN0ZWREYXRlKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IHthY3RpdmVFbGVtZW50LCBib2R5fSA9IGNhbGVuZGFyUmVmLmN1cnJlbnQub3duZXJEb2N1bWVudDtcbiAgICBjb25zdCBib2R5Rm9jdXNlZCA9IGFjdGl2ZUVsZW1lbnQgJiYgYWN0aXZlRWxlbWVudCA9PT0gYm9keTtcbiAgICBjb25zdCB7Y3VycmVudH0gPSByZWZzW2ZvY3VzZWREYXRlLmRhdGUoKSAtIDFdO1xuICAgIGNvbnN0IGRhdGVGb2N1c2VkID0gcmVmcy5zb21lKGVsID0+IGVsLmN1cnJlbnQgPT09IGFjdGl2ZUVsZW1lbnQpO1xuICAgIGNvbnN0IGNhbkZvY3VzID0gY3VycmVudCAmJiAoYm9keUZvY3VzZWQgfHwgZGF0ZUZvY3VzZWQpO1xuXG4gICAgaWYgKGNhbkZvY3VzKSBjdXJyZW50LmZvY3VzKCk7XG4gIH0sIFtyZWZzLCBmb2N1c2VkRGF0ZSwgdmFsdWVdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChkYXlqcyh2YWx1ZSkuaXNWYWxpZCgpKSBzZXRGb2N1c2VkRGF0ZShkYXlqcyh2YWx1ZSkpO1xuICB9LCBbdmFsdWVdKTtcblxuICBjb25zdCBoYW5kbGVLZXlJbnB1dCA9IChzZWxlY3RGb2N1c2VkRGF0ZSwgZGlzYWJsZWQpID0+IGUgPT4ge1xuICAgIHN3aXRjaCAoZS5rZXkpIHtcbiAgICAgIGNhc2UgJ0Fycm93TGVmdCc6XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgc2V0Rm9jdXNlZERhdGUoZm9jdXNlZERhdGUuc3VidHJhY3QoMSwgJ2RheScpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdBcnJvd1JpZ2h0JzpcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzZXRGb2N1c2VkRGF0ZShmb2N1c2VkRGF0ZS5hZGQoMSwgJ2RheScpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdBcnJvd1VwJzpcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzZXRGb2N1c2VkRGF0ZShmb2N1c2VkRGF0ZS5zdWJ0cmFjdCgxLCAnd2VlaycpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdBcnJvd0Rvd24nOlxuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHNldEZvY3VzZWREYXRlKGZvY3VzZWREYXRlLmFkZCgxLCAnd2VlaycpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdTcGFjZSc6XG4gICAgICBjYXNlICdFbnRlcic6XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgaWYgKCFkaXNhYmxlZCkgc2VsZWN0Rm9jdXNlZERhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH07XG5cbiAgY29uc3QgaXNFbmFibGVkID0gKGRheTogZGF5anMuRGF5anMpID0+IHtcbiAgICBjb25zdCBpc1NhbWVPckFmdGVyTWluRGF0ZSA9XG4gICAgICBtaW5EYXRlICE9PSB1bmRlZmluZWQgPyBkYXkuaXNTYW1lKG1pbkRhdGUpIHx8IGRheS5pc0FmdGVyKG1pbkRhdGUpIDogdHJ1ZTtcbiAgICBjb25zdCBpc1NhbWVPckJlZm9yZU1heERhdGUgPVxuICAgICAgbWF4RGF0ZSAhPT0gdW5kZWZpbmVkID8gZGF5LmlzU2FtZShtYXhEYXRlKSB8fCBkYXkuaXNCZWZvcmUobWF4RGF0ZSkgOiB0cnVlO1xuICAgIGNvbnN0IGlzRmlsdGVyTWF0Y2ggPVxuICAgICAgZmlsdGVyRGF0ZSAhPT0gdW5kZWZpbmVkID8gZmlsdGVyRGF0ZShkYXkuZm9ybWF0KHQoJ0RBVEVfRk9STUFUJykpKSA6IHRydWU7XG5cbiAgICByZXR1cm4gaXNTYW1lT3JBZnRlck1pbkRhdGUgJiYgaXNTYW1lT3JCZWZvcmVNYXhEYXRlICYmIGlzRmlsdGVyTWF0Y2g7XG4gIH07XG5cbiAgcmV0dXJuIChcbiAgICA8ZGl2PlxuICAgICAgPENhbGVuZGFyVGFibGUgcmVmPXtjYWxlbmRhclJlZn0+XG4gICAgICAgIDxSb3c+XG4gICAgICAgICAgPE1vbnRoTmF2aWdhdGlvbj5cbiAgICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHNldEZvY3VzZWREYXRlKGZvY3VzZWREYXRlLnN1YnRyYWN0KDEsICdtb250aCcpLnNldCgnZGF0ZScsIDEpKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAg4oaQIHt0KCdQcmV2Jyl9XG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8L01vbnRoTmF2aWdhdGlvbj5cbiAgICAgICAgICA8TW9udGhOYW1lPntmb2N1c2VkRGF0ZS5mb3JtYXQoJ01NTU0gWVlZWScpfTwvTW9udGhOYW1lPlxuICAgICAgICAgIDxNb250aE5hdmlnYXRpb24+XG4gICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiBzZXRGb2N1c2VkRGF0ZShmb2N1c2VkRGF0ZS5hZGQoMSwgJ21vbnRoJykuc2V0KCdkYXRlJywgMSkpfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICB7dCgnTmV4dCcpfSDihpJcbiAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgIDwvTW9udGhOYXZpZ2F0aW9uPlxuICAgICAgICA8L1Jvdz5cbiAgICAgICAgPFJvdz5cbiAgICAgICAgICB7cmVwZWF0KHdlZWtEYXlDb3VudCkubWFwKChfLCBkYXlJbmRleCkgPT4gKFxuICAgICAgICAgICAgPFdlZWtkYXlOYW1lIGtleT17ZGF5SW5kZXh9PlxuICAgICAgICAgICAgICB7Zm9jdXNlZERhdGUuc2V0KCdkYXknLCBkYXlJbmRleCkuZm9ybWF0KCdkZCcpfVxuICAgICAgICAgICAgPC9XZWVrZGF5TmFtZT5cbiAgICAgICAgICApKX1cbiAgICAgICAgPC9Sb3c+XG4gICAgICAgIDxkaXY+XG4gICAgICAgICAge3BvcHVsYXRlTW9udGgoZm9jdXNlZERhdGUpLm1hcCgod2Vlaywgd2Vla0luZGV4KSA9PiAoXG4gICAgICAgICAgICA8Um93IGtleT17d2Vla0luZGV4fT5cbiAgICAgICAgICAgICAge3dlZWsubWFwKChkYXksIGRheUluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudERheSA9IGZvY3VzZWREYXRlLnNldCgnZGF0ZScsIGRheSk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0RGF0ZSA9ICgpID0+IG9uQ2hhbmdlKGN1cnJlbnREYXkuZm9ybWF0KHQoJ0RBVEVfRk9STUFUJykpKTtcbiAgICAgICAgICAgICAgICBjb25zdCBkaXNhYmxlZCA9ICFpc0VuYWJsZWQoY3VycmVudERheSk7XG4gICAgICAgICAgICAgICAgY29uc3QgaWZFbmFibGVkID0gZm4gPT4gZSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoIWRpc2FibGVkKSBmbihlKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICA8RGF5IGtleT17ZGF5SW5kZXh9IGlzU2VsZWN0ZWQ9e2N1cnJlbnREYXkuaXNTYW1lKHNlbGVjdGVkRGF0ZSl9PlxuICAgICAgICAgICAgICAgICAgICB7ZGF5ICYmIChcbiAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICByZWY9e3JlZnNbZGF5IC0gMV19XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2lmRW5hYmxlZChzZWxlY3REYXRlKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFyaWEtZGlzYWJsZWQ9e2Rpc2FibGVkfVxuICAgICAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duPXtoYW5kbGVLZXlJbnB1dChzZWxlY3REYXRlLCBkaXNhYmxlZCl9XG4gICAgICAgICAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXtjdXJyZW50RGF5LmZvcm1hdCgnZGRkZCwgTU1NTSBELCBZWVlZJykudG9TdHJpbmcoKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYkluZGV4PXtkYXkgPT09IGZvY3VzZWREYXRlLmRhdGUoKSA/IDAgOiAtMX1cbiAgICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7ZGF5fVxuICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICAgICAgPC9EYXk+XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSl9XG4gICAgICAgICAgICA8L1Jvdz5cbiAgICAgICAgICApKX1cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L0NhbGVuZGFyVGFibGU+XG4gICAgPC9kaXY+XG4gICk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBFekNhbGVuZGFyO1xuIl19